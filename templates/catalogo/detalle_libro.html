{% extends 'base.html' %}

{% block content %}
<div class="container mt-5 pt-4 mb-5">
    <div class="row">
        <div class="col-md-6">
            <img src="{{ libro.portada.url }}" alt="Imagen del libro" class="img-fluid">
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h2>{{ libro.titulo }}</h2>
                    <p><strong>Autor:</strong> {{ libro.autor }}</p>
                    <p><strong>ISBN:</strong> {{ libro.isbn }}</p>
                    <p><strong>Editorial:</strong> {{ libro.editorial }}</p>
                    
                    <hr>
                    
                    <div class="book-actions">
                        {% if user.is_authenticated %}
                            <!-- Usuario autenticado -->
                            {% if libro.copias_disponibles > 0 %}
                                <!-- HAY copias disponibles -->
                                <p class="text-success mb-3">
                                    <i class="bi bi-check-circle-fill"></i> 
                                    Disponible para préstamo ({{ libro.copias_disponibles }} copia{{ libro.copias_disponibles|pluralize }})
                                </p>
                                <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#modalPrestamo">
                                    <i class="bi bi-book"></i> Solicitar Préstamo
                                </button>
                            {% else %}
                                <!-- NO hay copias disponibles -->
                                <p class="text-danger mb-3">
                                    <i class="bi bi-x-circle-fill"></i> 
                                    No hay copias disponibles en este momento
                                </p>
                                <button type="button" class="btn btn-warning w-100" data-bs-toggle="modal" data-bs-target="#modalReserva">
                                    <i class="bi bi-bookmark-heart"></i> Reservar
                                </button>
                            {% endif %}
                        {% else %}
                            <!-- Usuario NO autenticado -->
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 
                                Debes <a href="{% url 'usuarios:login' %}?next={{ request.path }}" class="alert-link">iniciar sesión</a> 
                                para solicitar préstamos o reservas.
                            </div>
                            <a href="{% url 'usuarios:login' %}?next={{ request.path }}" class="btn btn-primary w-100">
                                <i class="bi bi-box-arrow-in-right"></i> Iniciar Sesión
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PRÉSTAMO -->
<div class="modal fade" id="modalPrestamo" tabindex="-1" aria-labelledby="modalPrestamoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPrestamoLabel">Solicitar Préstamo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p>
                    Este libro forma parte de un corpus vivo: una constelación de voces de mujeres
                    que resisten, recuerdan y escriben para dejar huella.
                </p>
                <ul>
                    <li>Tiempo de compañía: 14 días para leerlo, habitarlo y devolverlo al mundo.</li>
                    <li>Renovación: posible si nadie más lo espera.</li>
                    <li>Disponibilidad: los ejemplares son cuerpos finitos, compartidos.</li>
                    <li>Devolución: cuídalo —viaja de mano en mano, sosteniendo memoria.</li>
                    <li>Circulación: cada lectura mantiene viva esta cadena de voces.</li>
                </ul>
                <p>Si deseas continuar, <strong>{{ libro.titulo }}</strong> te espera.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarPrestamo()">Confirmar Préstamo</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL RESERVA -->
<div class="modal fade" id="modalReserva" tabindex="-1" aria-labelledby="modalReservaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalReservaLabel">Reservar Libro</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p>Este libro está en manos de otrx lectorx.</p>
                <p>
                    Todas las copias disponibles están siendo leídas.
                    Cada una recorre ahora otra vida, otro espacio, otra memoria.
                    Si quieres, puedes reservarlo y te avisaremos cuando regrese a la estantería.
                    La lectura también es un acto de espera.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Volver</button>
                <button type="button" class="btn btn-primary" onclick="confirmarReserva()">Confirmar Reserva</button>
            </div>
        </div>
    </div>
</div>

<!-- Formularios ocultos -->
<form id="formPrestamo" method="post" action="{% url 'prestamos:solicitar_prestamo' libro.id %}" style="display: none;">
    {% csrf_token %}
</form>

<form id="formReserva" method="post" action="{% url 'prestamos:reservar_libro' libro.id %}" style="display: none;">
    {% csrf_token %}
</form>

{% endblock %}

{% block scripts %}
<script>
function confirmarPrestamo() {
    var modal = bootstrap.Modal.getInstance(document.getElementById('modalPrestamo'));
    modal.hide();
    setTimeout(function() {
        document.getElementById('formPrestamo').submit();
    }, 300);
}

function confirmarReserva() {
    var modal = bootstrap.Modal.getInstance(document.getElementById('modalReserva'));
    modal.hide();
    setTimeout(function() {
        document.getElementById('formReserva').submit();
    }, 300);
}

// Limpieza de backdrop
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.modal').forEach(function(modalEl) {
        modalEl.addEventListener('hidden.bs.modal', function() {
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            document.querySelectorAll('.modal-backdrop').forEach(function(backdrop) {
                backdrop.remove();
            });
        });
    });
});
</script>
{% endblock %}